<!DOCTYPE html>
<html>
<head>
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx Debug</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; height: 400px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { margin: 5px; padding: 10px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx Debug</h1>
    
    <div class="section">
        <h3>üì° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Service</h3>
        <button onclick="testWebSocketService()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Service</button>
        <button onclick="testSetGuestTemporaryId()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö setGuestTemporaryId</button>
        <button onclick="testSubscribe()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Subscribe</button>
    </div>
    
    <div class="section">
        <h3>üé´ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Temporary ID</h3>
        <input type="text" id="tempId" value="GUEST-A1B2C3D4" placeholder="‡πÉ‡∏™‡πà Temporary ID">
        <button onclick="testWithTempId()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Temporary ID</button>
    </div>
    
    <div class="section">
        <h3>üìù Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
        <div class="log" id="log"></div>
    </div>

    <script>
        // Simulate WebSocketService
        class MockWebSocketService {
            constructor() {
                this.guestWs = null;
                this.guestTemporaryId = null;
                this.listeners = new Map();
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 3;
                this.baseUrl = 'http://localhost:8000/api/';
            }

            setGuestTemporaryId(temporaryId) {
                log(`üé´ setGuestTemporaryId() called with temporaryId: ${temporaryId}`, 'info');
                log('üîç WebSocket state before setting temporaryId:', 'info');
                
                this.guestTemporaryId = temporaryId;
                
                if (temporaryId) {
                    log(`üîó Setting up guest WebSocket for temporary_id: ${temporaryId}`, 'info');
                    
                    if (this.guestWs && this.guestWs.readyState === WebSocket.OPEN) {
                        log(`üì° WebSocket already connected, subscribing to guest order: ${temporaryId}`, 'success');
                        this.subscribeToGuestOrder(temporaryId);
                    } else {
                        log(`üîó Connecting guest WebSocket for temporary_id: ${temporaryId}`, 'info');
                        this.connectGuest();
                    }
                }
            }

            connectGuest() {
                log('üîó connectGuest() called', 'info');
                
                if (this.guestWs && this.guestWs.readyState === WebSocket.OPEN) {
                    log('‚úÖ Guest WebSocket already connected, skipping connection...', 'success');
                    return;
                }

                if (this.guestWs && this.guestWs.readyState !== WebSocket.CLOSED) {
                    log('üîå Closing existing guest WebSocket connection...', 'warning');
                    this.guestWs.close();
                    this.guestWs = null;
                }

                this.reconnectAttempts = 0;
                const wsUrl = 'ws://localhost:8000/ws/guest-orders/';
                
                log(`üîó Connecting to Guest WebSocket: ${wsUrl}`, 'info');
                
                this.guestWs = new WebSocket(wsUrl);
                this.guestWs._isConnected = false;

                this.guestWs.onopen = () => {
                    log('‚úÖ Guest WebSocket connected successfully', 'success');
                    this.guestWs._isConnected = true;
                    this.reconnectAttempts = 0;
                    
                    if (this.guestTemporaryId) {
                        log(`üì° Auto-subscribing to guest order: ${this.guestTemporaryId}`, 'success');
                        setTimeout(() => {
                            if (this.guestWs && this.guestWs.readyState === WebSocket.OPEN) {
                                this.subscribeToGuestOrder(this.guestTemporaryId);
                            }
                        }, 500);
                    }
                };

                this.guestWs.onclose = (event) => {
                    log(`üîå Guest WebSocket disconnected, code: ${event.code}`, 'warning');
                    this.guestWs._isConnected = false;
                };

                this.guestWs.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Guest WebSocket message received: ${JSON.stringify(data)}`, 'info');
                        this.handleMessage(data);
                    } catch (error) {
                        log(`‚ùå Error parsing guest WebSocket message: ${error.message}`, 'error');
                    }
                };
                
                this.guestWs.onerror = (error) => {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                };
            }

            subscribeToGuestOrder(temporaryId) {
                log(`üì° subscribeToGuestOrder() called with temporaryId: ${temporaryId}`, 'info');
                
                if (this.guestWs && this.guestWs.readyState === WebSocket.OPEN) {
                    log(`üì° Subscribing to guest order: ${temporaryId}`, 'success');
                    this.sendGuest('subscribe_guest_order', { temporary_id: temporaryId });
                } else {
                    log(`‚ö†Ô∏è Cannot subscribe to guest order ${temporaryId}: WebSocket not connected`, 'error');
                }
            }

            sendGuest(type, payload) {
                log(`üì§ sendGuest() called with type: ${type}, payload: ${JSON.stringify(payload)}`, 'info');
                
                if (this.guestWs && this.guestWs.readyState === WebSocket.OPEN) {
                    this.guestWs.send(JSON.stringify({ type, payload }));
                    log('‚úÖ Message sent successfully', 'success');
                } else {
                    log('‚ùå WebSocket is not connected', 'error');
                }
            }

            handleMessage(data) {
                const { type } = data;
                log(`üì® Handling message type: ${type}`, 'info');
                
                if (this.listeners.has(type)) {
                    log(`üì§ Executing ${this.listeners.get(type).size} listeners for type: ${type}`, 'success');
                    this.listeners.get(type).forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            log(`‚ùå Error in message handler for type ${type}: ${error.message}`, 'error');
                        }
                    });
                } else {
                    log(`‚ö†Ô∏è No listeners found for message type: ${type}`, 'warning');
                }
            }

            on(eventType, callback) {
                log(`üìù Registering listener for event type: ${eventType}`, 'info');
                if (!this.listeners.has(eventType)) {
                    this.listeners.set(eventType, new Set());
                }
                this.listeners.get(eventType).add(callback);
            }

            off(eventType, callback) {
                if (this.listeners.has(eventType)) {
                    this.listeners.get(eventType).delete(callback);
                }
            }

            isGuestConnected() {
                return this.guestWs && this.guestWs.readyState === WebSocket.OPEN;
            }

            disconnectGuest() {
                if (this.guestWs) {
                    this.guestWs.close();
                    this.guestWs = null;
                    log('üîå Guest WebSocket disconnected', 'info');
                }
            }
        }

        // Global WebSocket service instance
        const websocketService = new MockWebSocketService();

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testWebSocketService() {
            log('üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Service', 'info');
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            websocketService.connectGuest();
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ subscribe
            setTimeout(() => {
                if (websocketService.isGuestConnected()) {
                    websocketService.subscribeToGuestOrder('GUEST-TEST-123');
                }
            }, 2000);
        }

        function testSetGuestTemporaryId() {
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö setGuestTemporaryId', 'info');
            
            const tempId = document.getElementById('tempId').value;
            websocketService.setGuestTemporaryId(tempId);
        }

        function testSubscribe() {
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Subscribe', 'info');
            
            const tempId = document.getElementById('tempId').value;
            if (websocketService.isGuestConnected()) {
                websocketService.subscribeToGuestOrder(tempId);
            } else {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
            }
        }

        function testWithTempId() {
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Temporary ID', 'info');
            
            const tempId = document.getElementById('tempId').value;
            
            // Simulate GuestOrders.jsx behavior
            log('üîç GuestOrders component - temporary_id from URL: ' + tempId, 'info');
            
            if (!tempId) {
                log('‚ö†Ô∏è No temporary_id provided, skipping WebSocket connection', 'warning');
                return;
            }

            log(`üîó Setting up WebSocket for temporary_id: ${tempId}`, 'info');
            
            // ‡∏õ‡∏¥‡∏î connection ‡πÄ‡∏Å‡πà‡∏≤
            websocketService.disconnectGuest();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ temporary_id
            websocketService.setGuestTemporaryId(tempId);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener
            websocketService.on('guest_order_status_update', (data) => {
                log('üîÑ Received guest_order_status_update: ' + JSON.stringify(data), 'success');
            });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx Debug', 'info');
        log('üí° 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Service" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'info');
        log('üí° 2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö setGuestTemporaryId" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ temporary_id', 'info');
        log('üí° 3. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Temporary ID" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á GuestOrders.jsx', 'info');
    </script>
</body>
</html> 