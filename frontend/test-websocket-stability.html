<!DOCTYPE html>
<html>
<head>
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Stability</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; height: 400px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { margin: 5px; padding: 10px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üîó ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Stability</h1>
    
    <div class="section">
        <h3>üì° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
        <div id="connectionStatus" class="status disconnected">‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
        <button onclick="connectWebSocket()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket</button>
        <button onclick="disconnectWebSocket()">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        <button onclick="checkStatus()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
    </div>
    
    <div class="section">
        <h3>üé´ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Temporary ID</h3>
        <input type="text" id="tempId" value="GUEST-0C3057AD" placeholder="‡πÉ‡∏™‡πà Temporary ID">
        <button onclick="subscribeToOrder()">Subscribe to Order</button>
        <button onclick="testPing()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Ping</button>
    </div>
    
    <div class="section">
        <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
        <div id="connectionInfo">
            <p><strong>WebSocket URL:</strong> <span id="wsUrl">-</span></p>
            <p><strong>Ready State:</strong> <span id="readyState">-</span></p>
            <p><strong>Connected:</strong> <span id="isConnected">-</span></p>
            <p><strong>Temporary ID:</strong> <span id="currentTemporaryId">-</span></p>
            <p><strong>Connection Time:</strong> <span id="connectionTime">-</span></p>
        </div>
    </div>
    
    <div class="section">
        <h3>üìù Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
        <div class="log" id="log"></div>
    </div>

    <script>
        let ws = null;
        let currentTemporaryId = null;
        let connectionStartTime = null;
        let pingInterval = null;

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateConnectionStatus(status, className) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }

        function updateConnectionInfo() {
            if (ws) {
                document.getElementById('wsUrl').textContent = ws.url || 'N/A';
                document.getElementById('readyState').textContent = getReadyStateText(ws.readyState);
                document.getElementById('isConnected').textContent = ws.readyState === WebSocket.OPEN ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà';
            } else {
                document.getElementById('wsUrl').textContent = 'N/A';
                document.getElementById('readyState').textContent = 'N/A';
                document.getElementById('isConnected').textContent = '‡πÑ‡∏°‡πà';
            }
            document.getElementById('currentTemporaryId').textContent = currentTemporaryId || 'N/A';
            
            if (connectionStartTime) {
                const duration = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('connectionTime').textContent = `${duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
            } else {
                document.getElementById('connectionTime').textContent = '-';
            }
        }

        function getReadyStateText(readyState) {
            switch (readyState) {
                case WebSocket.CONNECTING: return 'CONNECTING (0)';
                case WebSocket.OPEN: return 'OPEN (1)';
                case WebSocket.CLOSING: return 'CLOSING (2)';
                case WebSocket.CLOSED: return 'CLOSED (3)';
                default: return 'UNKNOWN';
            }
        }

        function connectWebSocket() {
            try {
                log('üîó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...', 'info');
                updateConnectionStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'disconnected');

                const wsUrl = 'ws://localhost:8000/ws/guest-orders/';
                log(`üîó WebSocket URL: ${wsUrl}`, 'info');

                ws = new WebSocket(wsUrl);
                connectionStartTime = Date.now();

                ws.onopen = function(event) {
                    log('‚úÖ WebSocket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    updateConnectionStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'connected');
                    updateConnectionInfo();
                    
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏° ping interval
                    startPingInterval();
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${JSON.stringify(data)}`, 'info');
                        
                        if (data.type === 'connection_established') {
                            log('‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'success');
                        } else if (data.type === 'pong') {
                            log('üèì ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Pong response', 'success');
                        } else if (data.type === 'guest_order_status_update') {
                            log('üîÑ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö guest_order_status_update!', 'success');
                            log(`üì¶ Order: ${data.temporary_id} - ${data.old_status} ‚Üí ${data.new_status}`, 'success');
                        }
                    } catch (error) {
                        log(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ parse ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${error.message}`, 'error');
                    }
                };

                ws.onclose = function(event) {
                    log(`üîå WebSocket ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (code: ${event.code}, reason: ${event.reason})`, 'warning');
                    log('üîç Close event details:', 'info');
                    log(`   - Code: ${event.code}`, 'info');
                    log(`   - Reason: ${event.reason}`, 'info');
                    log(`   - Was Clean: ${event.wasClean}`, 'info');
                    
                    updateConnectionStatus('‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'disconnected');
                    updateConnectionInfo();
                    
                    // ‡∏´‡∏¢‡∏∏‡∏î ping interval
                    stopPingInterval();
                    
                    if (event.code !== 1000) {
                        log('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà code 1000)', 'warning');
                    }
                };

                ws.onerror = function(error) {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                    updateConnectionStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'disconnected');
                    updateConnectionInfo();
                };

            } catch (error) {
                log(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á WebSocket: ${error.message}`, 'error');
                updateConnectionStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'disconnected');
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                log('üîå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...', 'info');
                ws.close(1000, 'Manual disconnect');
                ws = null;
                currentTemporaryId = null;
                connectionStartTime = null;
                updateConnectionInfo();
            } else {
                log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ WebSocket ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà', 'warning');
            }
        }

        function subscribeToOrder() {
            const tempId = document.getElementById('tempId').value.trim();
            if (!tempId) {
                log('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Temporary ID', 'error');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            currentTemporaryId = tempId;
            const message = {
                type: 'subscribe_guest_order',
                payload: { temporary_id: tempId }
            };

            log(`üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á subscribe ‡πÑ‡∏õ‡∏¢‡∏±‡∏á guest order: ${tempId}`, 'info');
            ws.send(JSON.stringify(message));
            updateConnectionInfo();
        }

        function testPing() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            const message = {
                type: 'ping',
                payload: { timestamp: Date.now() }
            };

            log('üèì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Ping...', 'info');
            ws.send(JSON.stringify(message));
        }

        function checkStatus() {
            log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ WebSocket', 'info');
            if (ws) {
                log(`   - Ready State: ${getReadyStateText(ws.readyState)}`, 'info');
                log(`   - URL: ${ws.url}`, 'info');
                log(`   - Buffered Amount: ${ws.bufferedAmount}`, 'info');
            } else {
                log('   - ‡πÑ‡∏°‡πà‡∏°‡∏µ WebSocket connection', 'info');
            }
            updateConnectionInfo();
        }

        function startPingInterval() {
            // ‡∏™‡πà‡∏á ping ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    testPing();
                }
            }, 30000);
            log('‚è∞ ‡πÄ‡∏£‡∏¥‡πà‡∏° ping interval (‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)', 'info');
        }

        function stopPingInterval() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
                log('‚è∞ ‡∏´‡∏¢‡∏∏‡∏î ping interval', 'info');
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(updateConnectionInfo, 1000);

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Stability', 'info');
        log('üí° 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'info');
        log('üí° 2. ‡πÉ‡∏™‡πà Temporary ID ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "Subscribe to Order"', 'info');
        log('üí° 3. ‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'info');
        log('üí° 4. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ping ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', 'info');
    </script>
</body>
</html> 