<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Guest Orders</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #0066cc; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Guest Orders</h1>
        
        <div class="test-section">
            <h3>üì° ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket</h3>
            <div id="connectionStatus" class="status disconnected">‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
            <button onclick="connectWebSocket()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket</button>
            <button onclick="disconnectWebSocket()">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
            <button onclick="clearLog()">‡∏•‡πâ‡∏≤‡∏á Log</button>
        </div>

        <div class="test-section">
            <h3>üé´ Subscribe to Guest Order</h3>
            <input type="text" id="temporaryId" placeholder="‡πÉ‡∏™‡πà Temporary ID" value="GUEST-A1B2C3D4">
            <button onclick="subscribeToOrder()">Subscribe to Order</button>
            <button onclick="subscribeToAllOrders()">Subscribe to All Orders</button>
            <button onclick="unsubscribeFromOrder()">Unsubscribe</button>
        </div>

        <div class="test-section">
            <h3>üì® ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
            <button onclick="sendPing()">‡∏™‡πà‡∏á Ping</button>
            <button onclick="testMessage()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <div class="test-section">
            <h3>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h3>
            <div id="connectionInfo">
                <p><strong>WebSocket URL:</strong> <span id="wsUrl">-</span></p>
                <p><strong>Ready State:</strong> <span id="readyState">-</span></p>
                <p><strong>Connected:</strong> <span id="isConnected">-</span></p>
                <p><strong>Temporary ID:</strong> <span id="currentTemporaryId">-</span></p>
            </div>
        </div>

        <div class="test-section">
            <h3>üìù Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentTemporaryId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateConnectionStatus(status, className) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }

        function updateConnectionInfo() {
            if (ws) {
                document.getElementById('wsUrl').textContent = ws.url || 'N/A';
                document.getElementById('readyState').textContent = getReadyStateText(ws.readyState);
                document.getElementById('isConnected').textContent = ws.readyState === WebSocket.OPEN ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà';
            } else {
                document.getElementById('wsUrl').textContent = 'N/A';
                document.getElementById('readyState').textContent = 'N/A';
                document.getElementById('isConnected').textContent = '‡πÑ‡∏°‡πà';
            }
            document.getElementById('currentTemporaryId').textContent = currentTemporaryId || 'N/A';
        }

        function getReadyStateText(readyState) {
            switch (readyState) {
                case WebSocket.CONNECTING: return 'CONNECTING (0)';
                case WebSocket.OPEN: return 'OPEN (1)';
                case WebSocket.CLOSING: return 'CLOSING (2)';
                case WebSocket.CLOSED: return 'CLOSED (3)';
                default: return 'UNKNOWN';
            }
        }

        function connectWebSocket() {
            try {
                log('üîó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...', 'info');
                updateConnectionStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'connecting');

                // ‡πÉ‡∏ä‡πâ localhost ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                const wsUrl = 'ws://localhost:8000/ws/guest-orders/';
                log(`üîó WebSocket URL: ${wsUrl}`, 'info');

                ws = new WebSocket(wsUrl);

                ws.onopen = function(event) {
                    log('‚úÖ WebSocket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    updateConnectionStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'connected');
                    updateConnectionInfo();
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${JSON.stringify(data, null, 2)}`, 'info');
                        
                        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
                        if (data.type === 'connection_established') {
                            log('‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'success');
                        } else if (data.type === 'pong') {
                            log('üèì ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Pong response', 'success');
                        } else if (data.type === 'guest_order_status_update') {
                            log(`üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${data.temporary_id} - ${data.old_status} ‚Üí ${data.new_status}`, 'success');
                        } else if (data.type === 'error') {
                            log(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${data.message}`, 'error');
                        }
                    } catch (error) {
                        log(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ parse ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${error.message}`, 'error');
                        log(`üìÑ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö: ${event.data}`, 'warning');
                    }
                };

                ws.onclose = function(event) {
                    log(`üîå WebSocket ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (code: ${event.code}, reason: ${event.reason})`, 'warning');
                    updateConnectionStatus('‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'disconnected');
                    updateConnectionInfo();
                    
                    if (event.code !== 1000) {
                        log('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà code 1000)', 'warning');
                    }
                };

                ws.onerror = function(error) {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                    updateConnectionStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'disconnected');
                    updateConnectionInfo();
                };

            } catch (error) {
                log(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á WebSocket: ${error.message}`, 'error');
                updateConnectionStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'disconnected');
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                log('üîå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...', 'info');
                ws.close(1000, 'Manual disconnect');
                ws = null;
                currentTemporaryId = null;
                updateConnectionInfo();
            } else {
                log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ WebSocket ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà', 'warning');
            }
        }

        function subscribeToOrder() {
            const temporaryId = document.getElementById('temporaryId').value.trim();
            if (!temporaryId) {
                log('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Temporary ID', 'error');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            currentTemporaryId = temporaryId;
            const message = {
                type: 'subscribe_guest_order',
                payload: {
                    temporary_id: temporaryId
                }
            };

            log(`üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á subscribe ‡πÑ‡∏õ‡∏¢‡∏±‡∏á guest order: ${temporaryId}`, 'info');
            ws.send(JSON.stringify(message));
            updateConnectionInfo();
        }

        function subscribeToAllOrders() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            const message = {
                type: 'subscribe_guest_order',
                payload: {
                    temporary_id: 'all'
                }
            };

            log('üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á subscribe ‡πÑ‡∏õ‡∏¢‡∏±‡∏á guest orders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'info');
            ws.send(JSON.stringify(message));
            currentTemporaryId = 'all';
            updateConnectionInfo();
        }

        function unsubscribeFromOrder() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            const message = {
                type: 'unsubscribe_guest_order',
                payload: {
                    temporary_id: currentTemporaryId || 'all'
                }
            };

            log(`üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á unsubscribe ‡∏à‡∏≤‡∏Å guest order: ${currentTemporaryId || 'all'}`, 'info');
            ws.send(JSON.stringify(message));
            currentTemporaryId = null;
            updateConnectionInfo();
        }

        function sendPing() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            const message = {
                type: 'ping',
                payload: {
                    timestamp: Date.now()
                }
            };

            log('üèì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Ping...', 'info');
            ws.send(JSON.stringify(message));
        }

        function testMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }

            const message = {
                type: 'test_message',
                payload: {
                    message: 'Hello from client!',
                    timestamp: Date.now()
                }
            };

            log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö...', 'info');
            ws.send(JSON.stringify(message));
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(updateConnectionInfo, 1000);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Guest Orders', 'info');
        log('üí° 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'info');
        log('üí° 2. ‡πÉ‡∏™‡πà Temporary ID ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "Subscribe to Order"', 'info');
        log('üí° 3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ', 'info');
        log('üí° 4. ‡∏î‡∏π log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á', 'info');
    </script>
</body>
</html> 