<!DOCTYPE html>
<html>
<head>
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx ‡∏à‡∏£‡∏¥‡∏á</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; height: 400px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { margin: 5px; padding: 10px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx ‡∏à‡∏£‡∏¥‡∏á</h1>
    
    <div class="section">
        <h3>üé´ ‡πÉ‡∏™‡πà Temporary ID</h3>
        <input type="text" id="tempId" value="GUEST-0C3057AD" placeholder="‡πÉ‡∏™‡πà Temporary ID">
        <button onclick="testGuestOrders()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx</button>
    </div>
    
    <div class="section">
        <h3>üì° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket</h3>
        <button onclick="testWebSocket()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket</button>
        <button onclick="testSubscribe()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Subscribe</button>
        <button onclick="testUpdateStatus()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
    </div>
    
    <div class="section">
        <h3>üìù Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
        <div class="log" id="log"></div>
    </div>

    <script>
        let ws = null;
        let currentTempId = null;

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testGuestOrders() {
            const tempId = document.getElementById('tempId').value;
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx behavior', 'info');
            log(`üîç GuestOrders component - temporary_id from URL: ${tempId}`, 'info');
            
            if (!tempId) {
                log('‚ö†Ô∏è No temporary_id provided, skipping WebSocket connection', 'warning');
                return;
            }

            log(`üîó Setting up WebSocket for temporary_id: ${tempId}`, 'info');
            
            // ‡∏õ‡∏¥‡∏î connection ‡πÄ‡∏Å‡πà‡∏≤
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ temporary_id
            currentTempId = tempId;
            
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
            connectWebSocket();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener
            setTimeout(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    subscribeToOrder(tempId);
                }
            }, 1000);
        }

        function connectWebSocket() {
            try {
                log('üîó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket...', 'info');
                ws = new WebSocket('ws://localhost:8000/ws/guest-orders/');
                
                ws.onopen = () => {
                    log('‚úÖ Guest WebSocket connected successfully', 'success');
                    
                    // Auto-subscribe if temporary_id is set
                    if (currentTempId) {
                        log(`üì° Auto-subscribing to guest order: ${currentTempId}`, 'success');
                        setTimeout(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                subscribeToOrder(currentTempId);
                            }
                        }, 500);
                    }
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Guest WebSocket message received: ${JSON.stringify(data)}`, 'info');
                        
                        if (data.type === 'connection_established') {
                            log('‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'success');
                        } else if (data.type === 'guest_order_status_update') {
                            log('üîÑ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö guest_order_status_update!', 'success');
                            log(`üì¶ Order: ${data.temporary_id} - ${data.old_status} ‚Üí ${data.new_status}`, 'success');
                        } else if (data.type === 'pong') {
                            log('üèì ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Pong response', 'success');
                        }
                    } catch (error) {
                        log(`‚ùå Error parsing message: ${error.message}`, 'error');
                    }
                };
                
                ws.onclose = (event) => {
                    log(`üîå Guest WebSocket disconnected, code: ${event.code}`, 'warning');
                };
                
                ws.onerror = (error) => {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                };
                
            } catch (error) {
                log(`‚ùå Error creating WebSocket: ${error.message}`, 'error');
            }
        }

        function subscribeToOrder(tempId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                return;
            }
            
            const message = {
                type: 'subscribe_guest_order',
                payload: { temporary_id: tempId }
            };
            
            log(`üì° Subscribing to guest order: ${tempId}`, 'info');
            ws.send(JSON.stringify(message));
        }

        function testWebSocket() {
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket connection', 'info');
            connectWebSocket();
        }

        function testSubscribe() {
            const tempId = document.getElementById('tempId').value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                subscribeToOrder(tempId);
            } else {
                log('‚ùå WebSocket ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
            }
        }

        async function testUpdateStatus() {
            const tempId = document.getElementById('tempId').value;
            log('üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'info');
            
            try {
                // ‡∏´‡∏≤ guest order ID ‡∏à‡∏≤‡∏Å temporary_id
                const response = await fetch(`http://localhost:8000/api/guest-orders/track/?temporary_id=${tempId}`);
                if (response.ok) {
                    const orderData = await response.json();
                    const guestOrderId = orderData.guest_order_id;
                    
                    log(`üìã Found Guest Order ID: ${guestOrderId}`, 'info');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ admin token)
                    log('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ admin token', 'warning');
                    log('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin Guest Orders', 'info');
                    
                } else {
                    log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö guest order', 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx ‡∏à‡∏£‡∏¥‡∏á', 'info');
        log('üí° 1. ‡πÉ‡∏™‡πà Temporary ID ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ó‡∏î‡∏™‡∏≠‡∏ö GuestOrders.jsx"', 'info');
        log('üí° 2. ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Admin Guest Orders ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'info');
        log('üí° 3. ‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö WebSocket notification ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà', 'info');
    </script>
</body>
</html> 